<div class="settings-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">Settings</h1>
    <p class="page-subtitle">Manage your application preferences and data</p>
  </div>

  <!-- Settings Grid -->
  <div class="settings-grid">

    <!-- General Settings Card -->
    <mat-card class="settings-card">
      <mat-card-header>
        <div class="card-header-content">
          <mat-card-title>
            <i class="fa fa-cog card-icon"></i>
            General Settings
          </mat-card-title>
          <mat-card-subtitle>Configure basic application settings</mat-card-subtitle>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="setting-item">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Currency</mat-label>
            <mat-select [compareWith]="compareWith" [(ngModel)]="currentSettings.currency">
              <mat-option>
                <ngx-mat-select-search [(ngModel)]="searchCurrency" placeholderLabel="Search currency..." noEntriesFoundLabel="'No Currency found'">
                </ngx-mat-select-search>
              </mat-option>
              <mat-option *ngFor="let currency of currencyList | filter:'name':searchCurrency" [value]="currency">
                {{currency.name}} ({{currency.symbol}})
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="setting-item">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Theme</mat-label>
            <mat-select [(ngModel)]="currentSettings.theme" (selectionChange)="onThemeChange($event)">
              <mat-option *ngFor="let theme of themeOptions" [value]="theme.value">
                <div class="theme-option">
                  <div class="theme-color-preview" [style.background-color]="theme.primaryColor"></div>
                  <span class="theme-name">{{theme.name}}</span>
                </div>
              </mat-option>
            </mat-select>
            <mat-hint>Choose your preferred color theme</mat-hint>
          </mat-form-field>
        </div>
      </mat-card-content>
      <mat-card-actions align="end">
        <button mat-raised-button color="primary" (click)="updateSettings()">
          <i class="fa fa-save"></i>
          Save Changes
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Payment Methods Card -->
    <mat-card class="settings-card">
      <mat-card-header>
        <div class="card-header-content">
          <mat-card-title>
            <i class="fa fa-credit-card card-icon"></i>
            Payment Methods
          </mat-card-title>
          <mat-card-subtitle>Manage your payment options</mat-card-subtitle>
        </div>
        <button class="icon-btn add-btn" (click)="openPaymentModal(addPaymentModeModal)" [matTooltip]="'Add Payment Method'" [attr.aria-label]="'addPayment'">
          <i class="fa fa-plus"></i>
        </button>
      </mat-card-header>
      <mat-card-content>
        <div class="items-list payment-methods-list">
          <div class="list-item" *ngFor="let mode of paymentModesList">
            <div class="item-info">
              <img [src]="mode.icon" class="item-icon" alt="payment-icon" />
              <span class="item-name">{{mode.name}}</span>
            </div>
            <div class="item-actions" *ngIf="mode.user">
              <button mat-icon-button class="icon-btn" matTooltip="Edit" (click)="openPaymentModal(addPaymentModeModal, mode)" [attr.aria-label]="'edit'">
                <i class="fa fa-edit"></i>
              </button>
              <button mat-icon-button class="icon-btn" matTooltip="Delete" (click)="onDeletePaymentMode(mode)" [attr.aria-label]="'delete'">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Categories Card -->
    <mat-card class="settings-card">
      <mat-card-header>
        <div class="card-header-content">
          <mat-card-title>
            <i class="fa fa-tags card-icon"></i>
            Categories
          </mat-card-title>
          <mat-card-subtitle>Organize your transactions</mat-card-subtitle>
        </div>
        <button class="icon-btn add-btn" (click)="openCategoryModal(addCategoryModal)" [matTooltip]="'Add Category'" [attr.aria-label]="'addCategory'">
          <i class="fa fa-plus"></i>
        </button>
      </mat-card-header>
      <mat-card-content>
        <div class="items-list categories-list">
          <div class="list-item" *ngFor="let category of categoryList">
            <div class="item-info">
              <img [src]="category.icon" class="item-icon" alt="category-icon" />
              <span class="item-name">{{category.name}}</span>
              <span class="item-badge" [class]="category.type">{{category.type}}</span>
            </div>
            <div class="item-actions" *ngIf="category.user">
              <button mat-icon-button class="icon-btn" matTooltip="Edit" (click)="openCategoryModal(addCategoryModal, category)" [attr.aria-label]="'edit'">
                <i class="fa fa-edit"></i>
              </button>
              <button mat-icon-button class="icon-btn" matTooltip="Delete" (click)="deleteCategory(category)" [attr.aria-label]="'delete'">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Data Management Card -->
    <mat-card class="settings-card">
      <mat-card-header>
        <div class="card-header-content">
          <mat-card-title>
            <i class="fa fa-database card-icon"></i>
            Data Management
          </mat-card-title>
          <mat-card-subtitle>Backup and restore your data</mat-card-subtitle>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="data-actions">
          <div class="action-item">
            <div class="action-info">
              <h4>Export Data</h4>
              <p>Download your data as a spreadsheet</p>
            </div>
            <button mat-raised-button color="primary" (click)="downloadSpreadsheet()">
              <i class="fa fa-download"></i>
              Download
            </button>
          </div>
          <mat-divider></mat-divider>
          <div class="action-item">
            <div class="action-info">
              <h4>Import Data</h4>
              <p>Upload transactions from a spreadsheet</p>
            </div>
            <button mat-raised-button color="primary" (click)="openCategoryModal(confirmUploadModal)">
              <i class="fa fa-upload"></i>
              Upload
            </button>
          </div>
        </div>
        <input class="hidden" type="file" accept=".xlsx" #filePicker (change)="uploadSpreadsheet($event)">
      </mat-card-content>
    </mat-card>

    <!-- Danger Zone Card -->
    <mat-card class="settings-card danger-card">
      <mat-card-header>
        <div class="card-header-content">
          <mat-card-title>
            <i class="fa fa-exclamation-triangle card-icon"></i>
            Danger Zone
          </mat-card-title>
          <mat-card-subtitle>Irreversible actions - proceed with caution</mat-card-subtitle>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="action-item">
          <div class="action-info">
            <h4>Delete All Transactions</h4>
            <p>This will permanently remove all your transaction data</p>
          </div>
          <button mat-raised-button color="warn" (click)="deleteTransactions()">
            <i class="fa fa-trash"></i>
            Delete All
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<ng-template #confirmUploadModal>
  <div class="modal-header">
    <h2 class="modal-title">Upload Spreadsheet</h2>
    <button type="button" class="btn-close close pull-right" aria-label="Close" (click)="confirmUploadmodalRef.hide()">
      <span aria-hidden="true" class="visually-hidden">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    Before uploading your spreadsheet, please make sure of the following,
    <div class="upload_instructions">
      <ol>
        <li>
          Columns of your sheet should be <br>
          A: Date (date of your transaction) <br>
          B: Category (find all the categories in the settings) <br>
          C: Amount (without currency) <br>
          D: Note
        </li>
        <li>
          Categories of your transactions should match with the listed categories in the settings
        </li>
      </ol>
    </div>
    <strong>Proceed with uploading your spreadsheet?</strong>
  </div>
  <div class="modal-footer">
    <button type="button" mat-button (click)="closeModal()">No</button>
    <button type="submit" mat-raised-button color="accent" (click)="browseFile()">Yes</button>
  </div>
</ng-template>

<ng-template #addCategoryModal>
  <div class="modal-header">
    <h2 class="modal-title">{{editCategory ? 'Modify' : 'Add'}} a category</h2>
    <button type="button" class="btn-close close pull-right" aria-label="Close" (click)="closeModal()">
      <span aria-hidden="true" class="visually-hidden">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <form class="add-category-form" [formGroup]="addCategoryForm">
      <mat-form-field appearance="outline">
        <mat-label>Name</mat-label>
        <input matInput formControlName="name" [maxlength]="30" required>
      </mat-form-field>

      <label class="text-14"><strong>Transaction type</strong></label>
      <mat-radio-group aria-label="Type" formControlName="type" required>
        <mat-radio-button class="pd-r10" value="expense">Expense</mat-radio-button>
        <mat-radio-button value="income">Income</mat-radio-button>
      </mat-radio-group>

      <label class="text-14 pd-t10"><strong>Choose an icon</strong></label>
      <mat-button-toggle-group name="iconPath" aria-label="icon" formControlName="icon">
        <mat-button-toggle [value]="icon" *ngFor="let icon of categoryIconPaths">
          <img class="icon" aria-hidden [src]="icon" alt="category-icon">
        </mat-button-toggle>
      </mat-button-toggle-group>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" mat-button (click)="closeModal()">Cancel</button>
    <button type="submit" mat-raised-button color="accent" (click)="addCategory()">{{editCategory ? 'Modify' : 'Add'}}</button>
  </div>
</ng-template>

<ng-template #addPaymentModeModal>
  <div class="modal-header">
    <h2 class="modal-title">{{editPaymentMode ? 'Modify' : 'Add'}} a Payment Mode</h2>
    <button type="button" class="btn-close close pull-right" aria-label="Close" (click)="closeModal()">
      <span aria-hidden="true" class="visually-hidden">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <form class="add-category-form" [formGroup]="addPaymentModeForm">
      <mat-form-field appearance="outline">
        <mat-label>Name</mat-label>
        <input matInput formControlName="name" [maxlength]="50" required>
      </mat-form-field>

      <label class="text-14 pd-t10"><strong>Choose an icon</strong></label>
      <mat-button-toggle-group name="iconPath" aria-label="icon" formControlName="icon">
        <mat-button-toggle [value]="icon" *ngFor="let icon of paymentIconPaths">
          <img class="icon" aria-hidden [src]="icon" alt="payment-icon">
        </mat-button-toggle>
      </mat-button-toggle-group>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" mat-button (click)="closeModal()">Cancel</button>
    <button type="submit" mat-raised-button color="accent" (click)="addPaymentMode()">{{editPaymentMode ? 'Modify' : 'Add'}}</button>
  </div>
</ng-template>